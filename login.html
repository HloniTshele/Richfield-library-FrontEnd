<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Login - Richfield Library System</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-[#0a1f44] flex flex-col min-h-screen text-white">

  <!-- Header -->
  <header class="bg-blue-800 text-white px-6 py-6 flex items-center justify-center shadow-md">
    <div class="flex items-center space-x-4">
      <a href="index.html" class="text-blue-400 hover:underline transition">
        <img src="https://cdn.briefly.co.za/images/720/6b4cbb0e53c53f0a.jpeg?v=1" alt="Richfield Library Logo" class="w-12 h-12 object-contain">
      </a>
      <h1 class="text-2xl font-bold">Richfield Library System</h1>
    </div>
  </header>

  <!-- Login Form -->
  <main class="flex-grow flex items-center justify-center px-4">
    <div class="bg-[#1e2f5b] rounded-lg shadow-lg w-full max-w-md p-8">
      <h2 class="text-2xl font-bold text-center mb-6">User Login</h2>

      <form id="loginForm" class="space-y-4">

        <!-- Email -->
        <div>
          <label for="email" class="block text-sm mb-1 font-semibold">Email</label>
          <input type="email" id="email" placeholder="Enter your email" required
            class="w-full px-4 py-2 border border-gray-400 rounded-lg bg-[#2c3e70] text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400">
        </div>

        <!-- Password -->
        <div>
          <label for="password" class="block text-sm mb-1 font-semibold">Password</label>
          <input type="password" id="password" placeholder="Enter your password" required
            class="w-full px-4 py-2 border border-gray-400 rounded-lg bg-[#2c3e70] text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400">
        </div>

        <!-- 2FA Section (Hidden by default) -->
        <div id="twofaSection" class="hidden">
          <label for="twofaCode" class="block text-sm mb-1 font-semibold">2FA Verification Code</label>
          <input type="text" id="twofaCode" placeholder="Enter 6-digit code from authenticator app" maxlength="6"
            class="w-full px-4 py-2 border border-gray-400 rounded-lg bg-[#2c3e70] text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400">
          <p class="text-xs text-gray-400 mt-1">Check your authenticator app (Google Authenticator, Authy, etc.) for the 6-digit code</p>
        </div>

        <!-- Login Button -->
        <button type="submit" id="loginButton"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition">
          Login
        </button>

        <!-- Back to Login Button (shown during 2FA) -->
        <button type="button" id="backToLoginButton" onclick="resetLoginForm()" 
          class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold transition hidden">
          Back to Login
        </button>

        <!-- Register Link -->
        <p class="text-center mt-4">
          <a href="register.html" class="text-blue-400 hover:underline">Don't have an account? Register here</a>
        </p>
      </form>

      <!-- Message Display -->
      <div id="message" class="mt-4 p-3 rounded-lg hidden"></div>

      <p class="text-gray-300 text-center mt-4 text-sm">
        Use your registered email and password to login
      </p>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-[#0a1f44] text-gray-300 py-4 text-center mt-auto">
    <p>&copy; 2025 Richfield Library System | Knowledge Nexus</p>
  </footer>

  <!-- Script -->
  <script>
    const API_BASE = 'http://localhost:3000';
    let currentEmail = '';
    let is2FAMode = false;

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const twofaCode = document.getElementById('twofaCode').value;
      const loginButton = document.getElementById('loginButton');
      const messageDiv = document.getElementById('message');

      // Clear previous messages
      messageDiv.className = 'mt-4 p-3 rounded-lg hidden';
      messageDiv.textContent = '';

      try {
        loginButton.disabled = true;
        loginButton.textContent = is2FAMode ? 'Verifying...' : 'Logging in...';

        console.log('Login attempt:', { 
          email: is2FAMode ? currentEmail : email, 
          has2FACode: !!twofaCode,
          is2FAMode,
          currentEmail // Debug current email state
        });

        let response;
        let requestBody;
        
        if (is2FAMode && twofaCode) {
          // 2FA verification step - FIXED: Use the stored currentEmail
          if (!currentEmail) {
            throw new Error('Email information lost during 2FA process. Please start over.');
          }
          
          requestBody = { 
            email: currentEmail, // Use the stored email, not the disabled input
            token: twofaCode 
          };
          
          console.log('Calling 2FA verification endpoint:', `${API_BASE}/verify-login-2fa`);
          console.log('2FA Request body:', requestBody);
          
          response = await fetch(`${API_BASE}/verify-login-2fa`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
          });
        } else {
          // Regular login step
          currentEmail = email.toLowerCase(); // Store email for 2FA step
          requestBody = { email, password };
          console.log('Calling signin endpoint:', `${API_BASE}/signin`);
          response = await fetch(`${API_BASE}/signin`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
          });
        }

        console.log('Response status:', response.status);
        
        let data;
        const contentType = response.headers.get('content-type');
        
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          try {
            data = JSON.parse(text);
          } catch (parseError) {
            throw new Error(`Server error: ${response.status} ${response.statusText}`);
          }
        } else {
          data = await response.json();
        }

        console.log('Full response data:', data);

        if (response.ok) {
          if (is2FAMode) {
            // 2FA verification successful
            console.log('2FA verification successful, processing login...');
            
            if (data.user) {
              // Add token to user data for storage
              const userWithToken = {
                ...data.user,
                token: data.token || 'logged-in'
              };
              
              handleSuccessfulLogin(userWithToken);
            } else {
              throw new Error('2FA verification succeeded but no user data received');
            }
          } else {
            // Check if 2FA is required
            if (data.requires2FA || data.message?.includes('2FA')) {
              // Ensure we have the email for 2FA step
              if (!currentEmail) {
                currentEmail = data.email || email;
              }
              enable2FAMode();
              showMessage('Two-factor authentication required. Please enter the code from your authenticator app.', 'info');
            } else if (data.user) {
              // Regular login successful (no 2FA)
              handleSuccessfulLogin(data);
            } else {
              throw new Error('Unexpected response format from server');
            }
          }
        } else {
          throw new Error(data.error || data.message || `Login failed (Status: ${response.status})`);
        }
      } catch (error) {
        console.error('Login error:', error);
        showMessage(error.message, 'error');
        
        // If 2FA verification fails, stay in 2FA mode but clear the code
        if (is2FAMode) {
          document.getElementById('twofaCode').value = '';
          document.getElementById('twofaCode').focus();
        } else {
          // Reset on initial login failure
          resetLoginForm();
        }
      } finally {
        loginButton.disabled = false;
        updateLoginButtonText();
      }
    });

    function enable2FAMode() {
      is2FAMode = true;
      document.getElementById('twofaSection').classList.remove('hidden');
      document.getElementById('backToLoginButton').classList.remove('hidden');
      document.getElementById('email').disabled = true;
      document.getElementById('password').disabled = true;
      document.getElementById('twofaCode').focus();
      updateLoginButtonText();
      
      // Display the email being used for 2FA
      const twofaSection = document.getElementById('twofaSection');
      let infoElement = document.getElementById('twofaEmailInfo');
      if (!infoElement) {
        infoElement = document.createElement('p');
        infoElement.id = 'twofaEmailInfo';
        infoElement.className = 'text-xs text-blue-400 mt-1';
        twofaSection.appendChild(infoElement);
      }
      infoElement.textContent = `Verifying code for: ${currentEmail}`;
    }

    function resetLoginForm() {
      is2FAMode = false;
      currentEmail = '';
      document.getElementById('twofaSection').classList.add('hidden');
      document.getElementById('backToLoginButton').classList.add('hidden');
      document.getElementById('email').disabled = false;
      document.getElementById('password').disabled = false;
      document.getElementById('twofaCode').value = '';
      document.getElementById('email').focus();
      updateLoginButtonText();
      document.getElementById('message').classList.add('hidden');
      
      // Remove the email info element if it exists
      const infoElement = document.getElementById('twofaEmailInfo');
      if (infoElement) {
        infoElement.remove();
      }
    }

    function updateLoginButtonText() {
      const loginButton = document.getElementById('loginButton');
      loginButton.textContent = is2FAMode ? 'Verify 2FA Code' : 'Login';
    }

    function handleSuccessfulLogin(userData) {
      console.log('Processing successful login with data:', userData);
      
      // Extract user data
      const user = userData.user || userData;
      
      if (!user || !user.role) {
        console.error('Invalid user data received:', user);
        throw new Error('Invalid user data received from server');
      }

      const welcomeMessage = user.name ? `Welcome ${user.name}` : 'Login successful';
      showMessage(`${welcomeMessage}! Redirecting...`, 'success');
      
      // Store user data in localStorage
      localStorage.setItem('user', JSON.stringify(user));
      if (user.token) {
        localStorage.setItem('token', user.token);
      } else {
        localStorage.setItem('token', 'logged-in');
      }
      
      console.log('User stored in localStorage:', user);
      
      // Redirect based on role
      setTimeout(() => {
        const role = user.role.toLowerCase();
        console.log('Redirecting to:', `${role}-dashboard.html`);
        
        switch(role) {
          case 'student':
            window.location.href = 'student-dashboard.html';
            break;
          case 'librarian':
            window.location.href = 'librarian-dashboard.html';
            break;
          case 'admin':
            window.location.href = 'admin-dashboard.html';
            break;
          default:
            window.location.href = 'dashboard.html';
        }
      }, 1500);
    }

    function showMessage(message, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = message;
      messageDiv.className = `mt-4 p-3 rounded-lg ${
        type === 'success' ? 'bg-green-600 text-white' :
        type === 'error' ? 'bg-red-600 text-white' :
        'bg-blue-600 text-white'
      }`;
      messageDiv.classList.remove('hidden');
    }

    // Check if user is already logged in
    document.addEventListener('DOMContentLoaded', () => {
      const user = localStorage.getItem('user');
      const token = localStorage.getItem('token');
      
      console.log('Page loaded. Stored user:', user);
      console.log('Stored token:', token ? 'Exists' : 'Missing');
      
      // Clear any incomplete 2FA login attempts
      if (user) {
        try {
          const userData = JSON.parse(user);
          // Clear if it's a 2FA pending object or invalid user data
          if ((userData.requires2FA && !userData.role) || !userData.role) {
            console.log('Found incomplete or invalid login, clearing...');
            localStorage.removeItem('user');
            localStorage.removeItem('token');
          }
        } catch (error) {
          console.error('Error parsing stored user data:', error);
          localStorage.removeItem('user');
          localStorage.removeItem('token');
        }
      }
    });

    // Allow Enter key to submit form in 2FA code field
    document.getElementById('twofaCode')?.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('loginForm').dispatchEvent(new Event('submit'));
      }
    });

    // Debug functions
    window.debug2FA = async function() {
      const email = prompt("Enter email:") || "hlonitshele@gmail.com";
      const token = prompt("Enter 6-digit 2FA code:");
      if (!token) return;
      
      try {
        const response = await fetch(`${API_BASE}/verify-login-2fa`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ email, token })
        });
        const data = await response.json();
        console.log('2FA Debug Result:', data);
        alert(response.ok ? '✅ Success: ' + JSON.stringify(data.user) : '❌ Failed: ' + data.error);
      } catch (error) {
        console.error('Debug error:', error);
        alert('Error: ' + error.message);
      }
    };

    window.clearStorage = function() {
      localStorage.removeItem('user');
      localStorage.removeItem('token');
      console.log('Storage cleared');
      location.reload();
    };

    // Debug current state
    window.debugState = function() {
      console.log('Current state:', {
        currentEmail,
        is2FAMode,
        emailInput: document.getElementById('email').value,
        emailDisabled: document.getElementById('email').disabled
      });
    };
  </script>
</body>
</html>